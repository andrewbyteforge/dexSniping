{% extends "base/layout.html" %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Professional Trading Dashboard{% endblock %}
{% block page_subtitle %}Real-time DEX monitoring and analytics{% endblock %}

{% block extra_css %}
<!-- Chart.js for data visualization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js" 
        crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0">
            Real-time DEX monitoring and trading analytics
            <span class="status-indicator ms-2">
                <span class="status-dot text-success"></span>
                <span class="connection-status text-success">Online</span>
            </span>
        </p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" id="refresh-dashboard" title="Refresh All Data">
            <i class="fas fa-sync-alt"></i>
            <span class="d-none d-sm-inline ms-1">Refresh</span>
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="toggle-auto-refresh" title="Toggle Auto-refresh">
            <i class="fas fa-play"></i>
            <span class="d-none d-sm-inline ms-1">Auto</span>
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-cog"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" id="export-data">Export Data</a></li>
                <li><a class="dropdown-item" href="#" id="dashboard-settings">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/docs" target="_blank">API Docs</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Dashboard Summary -->
<div class="card mb-4" style="background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-info) 100%); color: white;">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h2 class="h4 mb-2">Portfolio Overview</h2>
                <p class="mb-0 opacity-75">
                    Last updated: <span class="last-update-time">--:--</span>
                </p>
            </div>
            <div class="text-end">
                <div class="h5 mb-1">Total Value</div>
                <div class="h3 mb-0" id="total-portfolio-value">$0.00</div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-3 text-center">
                <div class="h4" id="summary-tokens">0</div>
                <small>Tokens Discovered</small>
            </div>
            <div class="col-md-3 text-center">
                <div class="h4" id="summary-trades">0</div>
                <small>Active Trades</small>
            </div>
            <div class="col-md-3 text-center">
                <div class="h4" id="summary-profit">$0.00</div>
                <small>24h P&L</small>
            </div>
            <div class="col-md-3 text-center">
                <div class="h4" id="summary-risk">0</div>
                <small>Avg Risk Score</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-2">
        <a href="/token-discovery" class="btn btn-outline-primary w-100">
            <i class="fas fa-search"></i><br>
            <small>Discover Tokens</small>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/live-trading" class="btn btn-outline-success w-100">
            <i class="fas fa-chart-line"></i><br>
            <small>Live Trading</small>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/portfolio" class="btn btn-outline-info w-100">
            <i class="fas fa-wallet"></i><br>
            <small>Portfolio</small>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/arbitrage" class="btn btn-outline-warning w-100">
            <i class="fas fa-exchange-alt"></i><br>
            <small>Arbitrage</small>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/analytics" class="btn btn-outline-secondary w-100">
            <i class="fas fa-chart-bar"></i><br>
            <small>Analytics</small>
        </a>
    </div>
    <div class="col-md-2">
        <a href="/api/v1/health" class="btn btn-outline-success w-100" target="_blank">
            <i class="fas fa-heart-pulse"></i><br>
            <small>System Health</small>
        </a>
    </div>
</div>

<!-- Stats Cards Section -->
<div class="card mb-4">
    <div class="card-header">
        <div class="widget-header">
            <h5 class="widget-title">
                <i class="fas fa-tachometer-alt me-2"></i>
                System Statistics
            </h5>
            <div class="widget-controls">
                <button class="btn btn-sm btn-outline-primary" id="refresh-stats" title="Refresh Stats">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% include 'components/stats-cards.html' %}
    </div>
</div>

<!-- Charts and Data Grid -->
<div class="dashboard-grid">
    <!-- Price Chart -->
    <div class="card">
        <div class="card-header">
            <div class="widget-header">
                <h5 class="widget-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Price Trends
                </h5>
                <div class="widget-controls">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chart-timeframe" id="timeframe-1h" checked>
                        <label class="btn btn-outline-primary" for="timeframe-1h">1H</label>
                        
                        <input type="radio" class="btn-check" name="chart-timeframe" id="timeframe-24h">
                        <label class="btn btn-outline-primary" for="timeframe-24h">24H</label>
                        
                        <input type="radio" class="btn-check" name="chart-timeframe" id="timeframe-7d">
                        <label class="btn btn-outline-primary" for="timeframe-7d">7D</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="price-chart" data-chart-type="price"></canvas>
                <div class="chart-loading" id="price-chart-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading price data...
                </div>
            </div>
        </div>
    </div>

    <!-- Portfolio Performance -->
    <div class="card">
        <div class="card-header">
            <div class="widget-header">
                <h5 class="widget-title">
                    <i class="fas fa-wallet me-2"></i>
                    Portfolio Performance
                </h5>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="portfolio-chart" data-chart-type="portfolio"></canvas>
                <div class="chart-loading" id="portfolio-chart-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading portfolio data...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Discovery and Alerts Grid -->
<div class="dashboard-grid">
    <!-- Token Discovery Table -->
    <div class="card">
        <div class="card-header">
            <div class="widget-header">
                <h5 class="widget-title">
                    <i class="fas fa-coins me-2"></i>
                    Recent Token Discoveries
                </h5>
                <div class="widget-controls">
                    <a href="/token-discovery" class="btn btn-sm btn-primary">
                        View All
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% include 'components/token-discovery-table.html' %}
        </div>
    </div>

    <!-- Live Alerts -->
    <div class="card">
        <div class="card-header">
            <div class="widget-header">
                <h5 class="widget-title">
                    <i class="fas fa-bell me-2"></i>
                    Live Alerts
                </h5>
                <div class="widget-controls">
                    <button class="btn btn-sm btn-outline-secondary" id="clear-alerts" title="Clear All Alerts">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% include 'components/live-alerts.html' %}
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="card">
    <div class="card-header">
        <div class="widget-header">
            <h5 class="widget-title">
                <i class="fas fa-gauge-high me-2"></i>
                Performance Metrics
            </h5>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-2 text-center">
                <div class="h5 text-info" id="metric-api-response">--ms</div>
                <small>API Response</small>
            </div>
            <div class="col-md-2 text-center">
                <div class="h5 text-success" id="metric-uptime">--%</div>
                <small>Uptime</small>
            </div>
            <div class="col-md-2 text-center">
                <div class="h5 text-warning" id="metric-memory">--MB</div>
                <small>Memory Usage</small>
            </div>
            <div class="col-md-2 text-center">
                <div class="h5 text-primary" id="metric-websocket">--ms</div>
                <small>WebSocket Latency</small>
            </div>
            <div class="col-md-2 text-center">
                <div class="h5 text-secondary" id="metric-cache-hit">--%</div>
                <small>Cache Hit Rate</small>
            </div>
            <div class="col-md-2 text-center">
                <div class="h5 text-info" id="metric-requests">--</div>
                <small>Requests/min</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('📊 Dashboard page loaded');

    // Initialize dashboard-specific functionality
    initializeDashboard();
    
    // Setup dashboard event listeners
    setupDashboardEvents();
    
    // Load initial chart data
    loadInitialCharts();
});

/**
 * Initialize dashboard functionality
 */
function initializeDashboard() {
    try {
        // Initialize charts if Chart Controller is available
        if (window.DexSniperApp && window.DexSniperApp.components && window.DexSniperApp.components.charts) {
            initializeCharts();
        }
        
        // Setup refresh handlers
        setupRefreshHandlers();
        
        // Initialize performance monitoring
        initializePerformanceMonitoring();
        
        console.log('✅ Dashboard initialized');
        
    } catch (error) {
        console.error('❌ Dashboard initialization failed:', error);
    }
}

/**
 * Initialize charts
 */
function initializeCharts() {
    try {
        const chartController = window.DexSniperApp.components.charts;
        
        // Initialize price chart with sample data
        setTimeout(() => {
            const priceData = generateSampleData('price', 20);
            if (chartController && typeof chartController.createChart === 'function') {
                chartController.createChart('price-chart', 'price', {
                    labels: priceData.labels,
                    datasets: [{
                        label: 'ETH/USD',
                        data: priceData.data,
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                });
            }
            
            // Hide loading indicators
            const priceLoading = document.getElementById('price-chart-loading');
            if (priceLoading) priceLoading.style.display = 'none';
        }, 1000);
        
        console.log('✅ Charts initialized');
        
    } catch (error) {
        console.error('❌ Failed to initialize charts:', error);
    }
}

/**
 * Setup dashboard event listeners
 */
function setupDashboardEvents() {
    // Refresh button
    const refreshBtn = document.getElementById('refresh-dashboard');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            console.log('🔄 Manual dashboard refresh');
            location.reload();
        });
    }

    // Auto-refresh toggle
    const autoRefreshBtn = document.getElementById('toggle-auto-refresh');
    if (autoRefreshBtn) {
        autoRefreshBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            if (icon.classList.contains('fa-play')) {
                icon.className = 'fas fa-pause';
                console.log('▶️ Auto-refresh enabled');
            } else {
                icon.className = 'fas fa-play';
                console.log('⏸️ Auto-refresh disabled');
            }
        });
    }

    // Chart timeframe buttons
    document.querySelectorAll('input[name="chart-timeframe"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateChartTimeframe(this.id.replace('timeframe-', ''));
        });
    });

    // Clear alerts
    const clearAlertsBtn = document.getElementById('clear-alerts');
    if (clearAlertsBtn) {
        clearAlertsBtn.addEventListener('click', function() {
            console.log('🗑️ Clear alerts clicked');
        });
    }
}

/**
 * Setup refresh handlers
 */
function setupRefreshHandlers() {
    // Stats refresh
    const refreshStatsBtn = document.getElementById('refresh-stats');
    if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener('click', function() {
            console.log('📊 Manual stats refresh');
        });
    }
}

/**
 * Initialize performance monitoring
 */
function initializePerformanceMonitoring() {
    // Update performance metrics every 10 seconds
    setInterval(updatePerformanceMetrics, 10000);
    
    // Initial update
    updatePerformanceMetrics();
}

/**
 * Update performance metrics
 */
function updatePerformanceMetrics() {
    try {
        // Mock performance data
        const metrics = {
            apiResponse: Math.round(Math.random() * 50 + 25),
            uptime: Math.round(((Date.now() - (window.PERFORMANCE_MONITOR?.startTime || Date.now())) / 3600000) * 100) / 100,
            memory: Math.round(Math.random() * 30 + 20),
            websocket: Math.round(Math.random() * 20 + 10),
            cacheHit: Math.round(Math.random() * 20 + 80),
            requests: Math.round(Math.random() * 100 + 50)
        };

        const elements = {
            'metric-api-response': metrics.apiResponse + 'ms',
            'metric-uptime': metrics.uptime + 'h',
            'metric-memory': metrics.memory + 'MB',
            'metric-websocket': metrics.websocket + 'ms',
            'metric-cache-hit': metrics.cacheHit + '%',
            'metric-requests': metrics.requests
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });

    } catch (error) {
        console.error('❌ Failed to update performance metrics:', error);
    }
}

/**
 * Update chart timeframe
 */
function updateChartTimeframe(timeframe) {
    console.log('📊 Updating chart timeframe:', timeframe);
    // This would normally update chart data based on timeframe
}

/**
 * Generate sample data for charts
 */
function generateSampleData(type, points) {
    const labels = [];
    const data = [];
    
    for (let i = 0; i < points; i++) {
        const date = new Date();
        date.setMinutes(date.getMinutes() - (points - i) * 5);
        labels.push(date.toLocaleTimeString());
        
        switch (type) {
            case 'price':
                data.push((Math.random() * 100 + 1500).toFixed(2));
                break;
            case 'volume':
                data.push(Math.floor(Math.random() * 1000000));
                break;
            default:
                data.push(Math.random() * 100);
        }
    }
    
    return { labels, data };
}

/**
 * Load initial chart data
 */
function loadInitialCharts() {
    // Charts will be initialized when components are ready
}
</script>
{% endblock %}