{% extends "base/layout.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block page_title %}Professional Trading Dashboard{% endblock %}
{% block page_subtitle %}Real-time DEX monitoring and AI-powered analysis{% endblock %}

{% block extra_css %}
<!-- Dashboard Opportunities Styling -->
<link href="{{ url_for('static', path='css/dashboard_opportunities.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Dashboard Status Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>System Status:</strong>
            <span class="ms-2">All systems operational</span>
            <div class="ms-auto">
                <small>Last update: <span id="lastUpdateTime">--:--:--</span></small>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Connection Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="bi bi-wallet2 text-primary"></i>
                            Wallet Connection
                        </h6>
                        <small class="text-muted">Connect your wallet to start trading</small>
                    </div>
                    
                    <!-- Wallet Status Display (when connected) -->
                    <div id="walletConnected" class="d-none">
                        <div class="d-flex align-items-center">
                            <div class="wallet-info me-3 text-end">
                                <div class="wallet-address fw-bold" id="connectedWalletAddress">0x1234...5678</div>
                                <small class="text-muted">
                                    <span id="connectedNetwork">Ethereum</span> ‚Ä¢ 
                                    <span id="connectedBalance">1.234 ETH</span>
                                </small>
                            </div>
                            <div class="wallet-avatar me-2">
                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <i class="bi bi-wallet2 text-white"></i>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-gear"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="walletManager.viewDetails()">
                                        <i class="bi bi-info-circle me-2"></i>View Details
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="walletManager.switchNetwork()">
                                        <i class="bi bi-arrow-repeat me-2"></i>Switch Network
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="walletManager.disconnect()">
                                        <i class="bi bi-box-arrow-right me-2"></i>Disconnect
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connect Wallet Button (when not connected) -->
                    <div id="walletDisconnected">
                        <button class="btn btn-primary" 
                                onclick="walletManager.showConnectionModal()" 
                                data-bs-toggle="modal" 
                                data-bs-target="#walletConnectionModal">
                            <i class="bi bi-wallet2 me-2"></i>
                            Connect Wallet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Portfolio Value</h6>
                        <h3 class="mb-0" id="portfolioValue">Loading...</h3>
                        <small class="text-white-50">
                            <i class="bi bi-graph-up"></i> 
                            <span id="portfolioChange">+0.00%</span>
                        </small>
                    </div>
                    <i class="bi bi-wallet2 fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Daily P&L</h6>
                        <h3 class="mb-0" id="dailyPnL">Loading...</h3>
                        <small class="text-white-50">
                            <span id="dailyPnLPercent">0.00%</span> return
                        </small>
                    </div>
                    <i class="bi bi-graph-up-arrow fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Active Trades</h6>
                        <h3 class="mb-0" id="activeTrades">0</h3>
                        <small class="text-white-50">
                            <span id="successRate">0%</span> success
                        </small>
                    </div>
                    <i class="bi bi-activity fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Discovered</h6>
                        <h3 class="mb-0" id="tokensDiscovered">0</h3>
                        <small class="text-white-50">
                            <span id="discovered24h">0</span> today
                        </small>
                    </div>
                    <i class="bi bi-search fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="row">
    <!-- Live Tokens Section -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-search text-primary"></i>
                    Live Opportunities
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshOpportunities()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                    <span class="badge bg-success">
                        <i class="bi bi-dot"></i>
                        Live
                    </span>
                </div>
            </div>
            <div class="card-body" style="height: 400px; overflow-y: auto;">
                <div id="tokensContainer">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Scanning for new opportunities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Side Panel -->
    <div class="col-lg-4 mb-4">
        <!-- Performance Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up text-primary"></i> 
                    Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 200px;">
                    <!-- Simple CSS-based chart alternative -->
                    <div id="performanceChart" class="simple-chart">
                        <div class="chart-title">Portfolio Performance (30 Days)</div>
                        <div class="chart-bars">
                            <div class="chart-bar" style="height: 60%;" title="Day 1: $10,200"></div>
                            <div class="chart-bar" style="height: 65%;" title="Day 5: $10,650"></div>
                            <div class="chart-bar" style="height: 58%;" title="Day 10: $10,100"></div>
                            <div class="chart-bar" style="height: 72%;" title="Day 15: $11,200"></div>
                            <div class="chart-bar" style="height: 68%;" title="Day 20: $10,800"></div>
                            <div class="chart-bar" style="height: 75%;" title="Day 25: $11,500"></div>
                            <div class="chart-bar" style="height: 80%;" title="Day 30: $12,000"></div>
                        </div>
                        <div class="chart-trend text-success">
                            <i class="bi bi-trending-up"></i> +18% this month
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Alerts -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bell text-danger"></i> 
                    Alerts
                </h5>
            </div>
            <div class="card-body" style="height: 250px; overflow-y: auto;">
                <div id="alertsContainer">
                    <div class="alert alert-info alert-sm">
                        <i class="bi bi-info-circle"></i>
                        <strong>New Token:</strong> MOONSHOT detected on Ethereum
                        <small class="d-block text-muted">2 minutes ago</small>
                    </div>
                    <div class="alert alert-warning alert-sm">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>High Volume:</strong> PEPE volume spike +300%
                        <small class="d-block text-muted">5 minutes ago</small>
                    </div>
                    <div class="alert alert-success alert-sm">
                        <i class="bi bi-check-circle"></i>
                        <strong>Trade Complete:</strong> WOJAK buy order executed
                        <small class="d-block text-muted">8 minutes ago</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet Connection Modal -->
<div class="modal fade" id="walletConnectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-wallet2 text-primary me-2"></i>
                    Connect Your Wallet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">
                    Choose your preferred wallet to connect and start trading on DEX Sniper Pro.
                </p>
                
                <!-- Loading State -->
                <div id="walletConnecting" class="text-center py-4 d-none">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Connecting...</span>
                    </div>
                    <p class="text-muted">Connecting to your wallet...</p>
                    <small class="text-muted">Please check your wallet for connection approval</small>
                </div>
                
                <!-- Wallet Options -->
                <div id="walletOptions">
                    <!-- MetaMask Option -->
                    <div class="wallet-option mb-3" onclick="walletManager.connectMetaMask()">
                        <div class="card h-100" style="cursor: pointer; transition: all 0.3s ease;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="wallet-icon me-3">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; background: linear-gradient(135deg, #f6911d, #ff6b35);">
                                            <span style="font-size: 24px;">ü¶ä</span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">MetaMask</h6>
                                        <p class="text-muted mb-1 small">Browser extension wallet</p>
                                        <div class="d-flex gap-1">
                                            <span class="badge bg-success">Most Popular</span>
                                            <span class="badge bg-info">Easy Setup</span>
                                        </div>
                                    </div>
                                    <div class="wallet-action">
                                        <i class="bi bi-chevron-right fs-5 text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WalletConnect Option -->
                    <div class="wallet-option mb-3" onclick="walletManager.connectWalletConnect()">
                        <div class="card h-100" style="cursor: pointer; transition: all 0.3s ease;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="wallet-icon me-3">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b99fc, #1e88e5);">
                                            <span style="font-size: 24px;">üì±</span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">WalletConnect</h6>
                                        <p class="text-muted mb-1 small">Scan QR code with your mobile wallet</p>
                                        <div class="d-flex gap-1">
                                            <span class="badge bg-warning">Mobile</span>
                                            <span class="badge bg-secondary">Secure</span>
                                        </div>
                                    </div>
                                    <div class="wallet-action">
                                        <i class="bi bi-chevron-right fs-5 text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coinbase Wallet Option -->
                    <div class="wallet-option mb-3" onclick="walletManager.connectCoinbaseWallet()">
                        <div class="card h-100" style="cursor: pointer; transition: all 0.3s ease;">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="wallet-icon me-3">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; background: linear-gradient(135deg, #0052ff, #0040cc);">
                                            <span style="font-size: 24px;">üíº</span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">Coinbase Wallet</h6>
                                        <p class="text-muted mb-1 small">Official Coinbase wallet extension</p>
                                        <div class="d-flex gap-1">
                                            <span class="badge bg-primary">Exchange</span>
                                        </div>
                                    </div>
                                    <div class="wallet-action">
                                        <i class="bi bi-chevron-right fs-5 text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Help -->
                <div class="mt-4 p-3 bg-light rounded">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>New to wallets?</strong> 
                        We recommend MetaMask for beginners. It's free and easy to set up.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add styling for wallet components and simple chart -->
<style>
/* Wallet Connection Styling */
.wallet-option .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #007bff;
}

.wallet-icon {
    transition: transform 0.3s ease;
}

.wallet-option:hover .wallet-icon {
    transform: scale(1.05);
}

/* Simple Chart Styling */
.simple-chart {
    padding: 1rem;
    text-align: center;
}

.chart-title {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.chart-bars {
    display: flex;
    align-items: end;
    justify-content: space-between;
    height: 120px;
    margin: 1rem 0;
    gap: 4px;
}

.chart-bar {
    background: linear-gradient(to top, #667eea, #764ba2);
    border-radius: 2px 2px 0 0;
    flex: 1;
    min-height: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.chart-bar:hover {
    transform: scaleY(1.1);
    filter: brightness(1.2);
}

.chart-trend {
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.alert-sm {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.alert-sm:last-child {
    margin-bottom: 0;
}

/* Stats card styling (if not already defined) */
.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
}

.stats-card .card-body {
    padding: 1.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // ==================== WALLET MANAGER CLASS ====================
    
    class WalletManager {
        constructor() {
            this.isConnected = false;
            this.walletAddress = null;
            this.walletType = null;
            this.connectionId = null;
            this.supportedNetworks = ['ethereum', 'polygon', 'bsc', 'arbitrum'];
            this.connectedNetworks = [];
            this.balances = {};
            
            console.log('üîó Wallet Manager initialized');
            this.checkExistingConnection();
        }
        
        async checkExistingConnection() {
            try {
                // Check if user has a wallet connected in localStorage
                const savedConnection = localStorage.getItem('walletConnection');
                if (savedConnection) {
                    const connectionData = JSON.parse(savedConnection);
                    if (connectionData.walletAddress && connectionData.connectionId) {
                        console.log('üîÑ Checking existing connection...');
                        // Verify connection is still valid
                        await this.verifyConnection(connectionData);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error checking existing connection:', error);
                this.clearStoredConnection();
            }
        }
        
        async verifyConnection(connectionData) {
            try {
                const response = await fetch(`/api/v1/live-trading/wallet/connections`);
                if (response.ok) {
                    const data = await response.json();
                    if (data[connectionData.connectionId]) {
                        this.setConnectedState(connectionData);
                        return true;
                    }
                }
                this.clearStoredConnection();
                return false;
            } catch (error) {
                console.error('‚ùå Connection verification failed:', error);
                return false;
            }
        }
        
        showConnectionModal() {
            console.log('üîó Opening wallet connection modal');
            // Reset modal state
            document.getElementById('walletOptions').style.display = 'block';
            document.getElementById('walletConnecting').classList.add('d-none');
        }
        
        async connectMetaMask() {
            console.log('ü¶ä Attempting MetaMask connection...');
            
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed. Please install MetaMask to continue.');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }
            
            try {
                this.showConnectingState();
                
                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    throw new Error('No accounts returned from MetaMask');
                }
                
                const walletAddress = accounts[0];
                console.log('‚úÖ MetaMask accounts retrieved:', walletAddress);
                
                // Connect via backend API
                const connectionData = await this.connectWalletAPI({
                    wallet_type: 'metamask',
                    wallet_address: walletAddress,
                    requested_networks: ['ethereum', 'polygon']
                });
                
                this.setConnectedState({
                    walletAddress: connectionData.wallet_address,
                    walletType: 'metamask',
                    connectionId: connectionData.connection_id,
                    connectedNetworks: connectionData.connected_networks,
                    balances: connectionData.balances
                });
                
                this.hideConnectionModal();
                console.log('‚úÖ MetaMask connected successfully');
                
            } catch (error) {
                console.error('‚ùå MetaMask connection failed:', error);
                this.showConnectionError('MetaMask connection failed: ' + error.message);
            }
        }
        
        async connectWalletConnect() {
            console.log('üì± Attempting WalletConnect connection...');
            
            try {
                this.showConnectingState();
                
                // For now, show coming soon message
                alert('WalletConnect integration coming soon! Please use MetaMask for now.');
                this.hideConnectingState();
                
            } catch (error) {
                console.error('‚ùå WalletConnect connection failed:', error);
                this.showConnectionError('WalletConnect connection failed: ' + error.message);
            }
        }
        
        async connectCoinbaseWallet() {
            console.log('üíº Attempting Coinbase Wallet connection...');
            
            try {
                this.showConnectingState();
                
                // For now, show coming soon message
                alert('Coinbase Wallet integration coming soon! Please use MetaMask for now.');
                this.hideConnectingState();
                
            } catch (error) {
                console.error('‚ùå Coinbase Wallet connection failed:', error);
                this.showConnectionError('Coinbase Wallet connection failed: ' + error.message);
            }
        }
        
        async connectWalletAPI(requestData) {
            const response = await fetch('/api/v1/live-trading/wallet/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'API connection failed');
            }
            
            return await response.json();
        }
        
        setConnectedState(connectionData) {
            this.isConnected = true;
            this.walletAddress = connectionData.walletAddress;
            this.walletType = connectionData.walletType;
            this.connectionId = connectionData.connectionId;
            this.connectedNetworks = connectionData.connectedNetworks || [];
            this.balances = connectionData.balances || {};
            
            // Store connection data
            localStorage.setItem('walletConnection', JSON.stringify(connectionData));
            
            // Update UI
            this.updateWalletUI();
        }
        
        updateWalletUI() {
            // Show connected state
            document.getElementById('walletConnected').classList.remove('d-none');
            document.getElementById('walletDisconnected').classList.add('d-none');
            
            // Update wallet info
            const addressElement = document.getElementById('connectedWalletAddress');
            if (addressElement && this.walletAddress) {
                addressElement.textContent = 
                    this.walletAddress.substring(0, 6) + '...' + 
                    this.walletAddress.substring(this.walletAddress.length - 4);
            }
            
            // Update network info
            const networkElement = document.getElementById('connectedNetwork');
            if (networkElement && this.connectedNetworks.length > 0) {
                networkElement.textContent = this.connectedNetworks[0].charAt(0).toUpperCase() + 
                                           this.connectedNetworks[0].slice(1);
            }
            
            // Update balance info
            const balanceElement = document.getElementById('connectedBalance');
            if (balanceElement && this.balances) {
                const firstNetwork = this.connectedNetworks[0];
                if (firstNetwork && this.balances[firstNetwork]) {
                    const balance = parseFloat(this.balances[firstNetwork].native_balance);
                    const symbol = this.balances[firstNetwork].native_symbol || 'ETH';
                    balanceElement.textContent = `${balance.toFixed(3)} ${symbol}`;
                }
            }
        }
        
        disconnect() {
            if (confirm('Are you sure you want to disconnect your wallet?')) {
                this.isConnected = false;
                this.walletAddress = null;
                this.walletType = null;
                this.connectionId = null;
                this.connectedNetworks = [];
                this.balances = {};
                
                // Clear stored data
                this.clearStoredConnection();
                
                // Update UI
                document.getElementById('walletConnected').classList.add('d-none');
                document.getElementById('walletDisconnected').classList.remove('d-none');
                
                console.log('üîå Wallet disconnected');
            }
        }
        
        viewDetails() {
            if (this.isConnected) {
                alert(`Wallet Details:\n\nAddress: ${this.walletAddress}\nType: ${this.walletType}\nNetworks: ${this.connectedNetworks.join(', ')}`);
            }
        }
        
        switchNetwork() {
            if (this.isConnected) {
                alert('Network switching coming soon! You can switch networks in your wallet for now.');
            }
        }
        
        showConnectingState() {
            document.getElementById('walletOptions').style.display = 'none';
            document.getElementById('walletConnecting').classList.remove('d-none');
        }
        
        hideConnectingState() {
            document.getElementById('walletOptions').style.display = 'block';
            document.getElementById('walletConnecting').classList.add('d-none');
        }
        
        hideConnectionModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('walletConnectionModal'));
            if (modal) {
                modal.hide();
            }
            this.hideConnectingState();
        }
        
        showConnectionError(message) {
            alert('Connection Error: ' + message);
            this.hideConnectingState();
        }
        
        clearStoredConnection() {
            localStorage.removeItem('walletConnection');
        }
    }
    
    // Initialize wallet manager
    let walletManager;
    
    // ==================== ENHANCED LOGGING UTILITIES ====================
    
    function debugLog(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = `[${timestamp}] DEX-${level.toUpperCase()}:`;
        
        switch (level) {
            case 'error':
                console.error(prefix, message, data || '');
                break;
            case 'warn':
                console.warn(prefix, message, data || '');
                break;
            case 'info':
                console.info(prefix, message, data || '');
                break;
            default:
                console.log(prefix, message, data || '');
        }
    }
    
    // ==================== GLOBAL VARIABLES ====================
    
    let dashboardData = {};
    let performanceChart = null;
    let chartInitialized = false;
    
    // ==================== MAIN INITIALIZATION ====================
    
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('info', 'üöÄ DEX Sniper Pro Dashboard starting...');
        
        // Initialize wallet manager first
        walletManager = new WalletManager();
        
        // Then initialize dashboard
        initializeDashboard();
    });
    
    async function initializeDashboard() {
        debugLog('info', 'üìä Initializing dashboard components...');
        
        try {
            // Skip Chart.js initialization - use CSS chart instead
            debugLog('info', 'üìà Using CSS-based chart (Chart.js skipped)');
            chartInitialized = true;
            
            // Load dashboard data
            debugLog('info', 'üìä Loading dashboard data...');
            await loadDashboardStats();
            await loadLiveTokens();
            
            // Setup auto-refresh
            debugLog('info', 'üîÑ Setting up auto-refresh...');
            setupAutoRefresh();
            
            debugLog('info', '‚úÖ Dashboard initialization complete');
            
        } catch (error) {
            debugLog('error', '‚ùå Dashboard initialization failed:', error);
            showError('Dashboard initialization failed. Some features may not work.');
        }
    }
    
    // ==================== API DATA LOADING ====================
    
    async function loadDashboardStats() {
        try {
            debugLog('info', 'üìä Fetching dashboard stats...');
            
            const response = await fetch('/api/v1/dashboard/stats');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            debugLog('info', '‚úÖ Dashboard stats received:', data);
            
            updateDashboardStats(data);
            dashboardData = data;
            
        } catch (error) {
            debugLog('error', '‚ùå Failed to load dashboard stats:', error);
            showError('Failed to load dashboard statistics');
        }
    }
    
    function updateDashboardStats(data) {
        try {
            debugLog('info', 'üîÑ Updating dashboard statistics display...');
            
            // Helper function to safely format values
            function safeFormat(value, type = 'number') {
                if (value === null || value === undefined) return '0';
                
                switch (type) {
                    case 'currency':
                        if (typeof value === 'string' && value.includes('$')) return value;
                        return formatCurrency(parseFloat(value) || 0);
                    
                    case 'percentage':
                        if (typeof value === 'string' && value.includes('%')) return value;
                        return (parseFloat(value) || 0).toFixed(1) + '%';
                    
                    case 'number':
                    default:
                        return (parseFloat(value) || 0).toString();
                }
            }
            
            // Extract data from response structure
            const statsData = data.data || data;
            
            // Update stats display with safe formatting
            updateElement('portfolioValue', safeFormat(statsData.portfolio_value, 'currency'));
            updateElement('dailyPnL', safeFormat(statsData.daily_pnl, 'currency'));
            updateElement('activeTrades', safeFormat(statsData.trades_today || statsData.active_trades, 'number'));
            updateElement('tokensDiscovered', safeFormat(statsData.total_discovered, 'number'));
            updateElement('successRate', safeFormat(statsData.success_rate, 'percentage'));
            updateElement('discovered24h', safeFormat(statsData.discovered_24h, 'number'));
            
            // Handle P&L percentage
            if (statsData.daily_pnl_percent !== undefined) {
                updateElement('dailyPnLPercent', safeFormat(statsData.daily_pnl_percent, 'percentage'));
            }
            
            // Handle portfolio change with color coding
            if (statsData.portfolio_value_change !== undefined) {
                const changeElement = document.getElementById('portfolioChange');
                if (changeElement) {
                    const changeValue = parseFloat(statsData.portfolio_value_change) || 0;
                    const isPositive = changeValue >= 0;
                    changeElement.textContent = (isPositive ? '+' : '') + safeFormat(changeValue, 'percentage');
                    changeElement.className = isPositive ? 'text-success' : 'text-danger';
                }
            }
            
            debugLog('info', '‚úÖ Dashboard statistics updated successfully');
            
        } catch (error) {
            debugLog('error', '‚ùå Error updating dashboard stats:', error);
        }
    }
    
    async function loadLiveTokens() {
        try {
            debugLog('info', 'üîç Fetching live opportunities...');
            
            const response = await fetch('/api/v1/tokens/discover?limit=10');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            debugLog('info', '‚úÖ Live opportunities received:', data);
            
            // Handle the API response structure correctly
            let tokens = null;
            if (data.tokens && Array.isArray(data.tokens)) {
                tokens = data.tokens;
                debugLog('info', `üìä Found ${tokens.length} tokens in data.tokens`);
            } else if (data.discovered_tokens && Array.isArray(data.discovered_tokens)) {
                tokens = data.discovered_tokens;
                debugLog('info', `üìä Found ${tokens.length} tokens in data.discovered_tokens`);
            } else if (Array.isArray(data)) {
                tokens = data;
                debugLog('info', `üìä Using direct array with ${tokens.length} tokens`);
            } else {
                debugLog('warn', '‚ö†Ô∏è No valid token array found in response');
                tokens = [];
            }
            
            if (tokens && tokens.length > 0) {
                debugLog('info', `üéØ Displaying ${tokens.length} opportunities`);
                displayLiveOpportunities(tokens);
            } else {
                debugLog('info', 'üìù No opportunities found, showing empty state');
                showNoTokensMessage();
            }
            
        } catch (error) {
            debugLog('error', '‚ùå Failed to load live opportunities:', error);
            showTokensError();
        }
    }
    
    function displayLiveOpportunities(tokens) {
        const container = document.getElementById('tokensContainer');
        
        debugLog('info', `üéØ displayLiveOpportunities called with ${tokens ? tokens.length : 0} tokens`);
        debugLog('info', `üéØ Container found: ${container ? 'YES' : 'NO'}`);
        
        if (!container) {
            debugLog('error', '‚ùå tokensContainer not found in DOM!');
            return;
        }
        
        if (!tokens || tokens.length === 0) {
            debugLog('info', '‚ö†Ô∏è No tokens to display');
            showNoTokensMessage();
            return;
        }
        
        let html = '';
        
        tokens.forEach((token, index) => {
            debugLog('debug', `Processing token ${index}:`, token);
            
            const price = parseFloat(token.price || token.current_price || 0);
            const priceChange = parseFloat(token.price_change_24h || token.price_change || token.change_24h || 0);
            const liquidity = parseFloat(token.liquidity || token.liquidity_usd || 0);
            const isPositive = priceChange >= 0;
            const aiScore = parseFloat(token.ai_score || token.score || Math.random() * 10);
            
            // Calculate age
            let ageText = 'Unknown';
            if (token.discovered_at || token.created_at) {
                const discoveredTime = new Date(token.discovered_at || token.created_at);
                const now = new Date();
                const diffMinutes = Math.floor((now - discoveredTime) / (1000 * 60));
                
                if (diffMinutes < 60) {
                    ageText = `${diffMinutes}m`;
                } else {
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = diffMinutes % 60;
                    ageText = `${hours}h ${minutes}m`;
                }
            }
            
            html += `
                <div class="opportunity-card p-3 mb-3" style="border: 1px solid #dee2e6; border-radius: 8px; background: white;">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="token-symbol fw-bold">${escapeHtml(token.symbol || 'UNKNOWN')}</div>
                            <small class="text-muted">${escapeHtml(token.name || 'Unknown Token')}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">$${price > 0 ? price.toFixed(8) : '0.00000000'}</div>
                            <div class="price-change-${isPositive ? 'positive' : 'negative'}" style="color: ${isPositive ? '#28a745' : '#dc3545'};">
                                ${isPositive ? '+' : ''}${priceChange.toFixed(1)}%
                            </div>
                        </div>
                        <div class="col-md-2">
                            <span class="liquidity-badge badge bg-info">$${formatLiquidity(liquidity)}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Age:</small>
                            <div class="fw-bold">${ageText}</div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-trade btn-sm me-2" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;" onclick="snipeToken('${token.symbol}', '${token.address || ''}')">
                                <i class="bi bi-lightning"></i>
                                Snipe
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showTokenInfo('${token.symbol}', '${token.address || ''}')">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">
                                Network: <span class="badge bg-secondary">${escapeHtml(token.network || 'Unknown')}</span>
                                ${aiScore > 0 ? ` | AI Score: <span class="badge ${aiScore > 7 ? 'bg-success' : aiScore > 4 ? 'bg-warning' : 'bg-danger'}">${aiScore.toFixed(1)}</span>` : ''}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Add "Load More" button
        html += `
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="loadMoreOpportunities()">
                    <i class="bi bi-plus-circle"></i>
                    Load More Opportunities
                </button>
            </div>
        `;
        
        debugLog('info', `üéØ Setting container HTML (${html.length} characters)`);
        
        try {
            container.innerHTML = html;
            debugLog('info', '‚úÖ Live opportunities display updated successfully');
        } catch (error) {
            debugLog('error', '‚ùå Error setting container HTML:', error);
        }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function formatLiquidity(value) {
        if (value >= 1000000) {
            return (value / 1000000).toFixed(1) + 'M';
        } else if (value >= 1000) {
            return (value / 1000).toFixed(1) + 'K';
        }
        return value.toFixed(0);
    }
    
    function updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            debugLog('debug', `Updated ${id}: ${value}`);
        } else {
            debugLog('warn', `Element not found: ${id}`);
        }
    }
    
    function formatCurrency(value) {
        try {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        } catch (error) {
            return '$' + (value || 0).toFixed(2);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ==================== ERROR HANDLING ====================
    
    function showError(message) {
        debugLog('error', 'Dashboard Error:', message);
        // Could add toast notification here
    }
    
    function showNoTokensMessage() {
        const container = document.getElementById('tokensContainer');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-info-circle fs-1"></i>
                    <p class="mt-3">No opportunities found at this time</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadLiveTokens()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            `;
        }
    }
    
    function showTokensError() {
        const container = document.getElementById('tokensContainer');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                    <p class="mt-3">Failed to load opportunities</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadLiveTokens()">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            `;
        }
    }
    
    // ==================== AUTO-REFRESH SYSTEM ====================
    
    function setupAutoRefresh() {
        // Update stats every 30 seconds
        setInterval(() => {
            debugLog('info', 'üîÑ Auto-refreshing dashboard stats...');
            loadDashboardStats();
        }, 30000);
        
        // Update tokens every 10 seconds
        setInterval(() => {
            debugLog('info', 'üîÑ Auto-refreshing opportunities...');
            loadLiveTokens();
        }, 10000);
        
        // Update timestamp every second
        setInterval(updateTimestamp, 1000);
        
        debugLog('info', '‚úÖ Auto-refresh system activated');
    }
    
    function updateTimestamp() {
        const element = document.getElementById('lastUpdateTime');
        if (element) {
            element.textContent = new Date().toLocaleTimeString();
        }
    }
    
    // ==================== OPPORTUNITY ACTIONS ====================
    
    function snipeToken(symbol, address) {
        debugLog('info', `‚ö° Snipe action triggered for ${symbol} (${address})`);
        
        // Check if wallet is connected first
        if (!walletManager.isConnected) {
            alert('Please connect your wallet first to execute trades.');
            walletManager.showConnectionModal();
            const modal = new bootstrap.Modal(document.getElementById('walletConnectionModal'));
            modal.show();
            return;
        }
        
        if (confirm(`Execute snipe trade for ${symbol}?\n\nThis will attempt to buy this token using your configured trading parameters.`)) {
            alert(`Snipe order submitted for ${symbol}!\n\nNote: This is a demonstration. In production, this would connect to your trading engine.`);
        }
    }
    
    function showTokenInfo(symbol, address) {
        debugLog('info', `‚ÑπÔ∏è Show info requested for ${symbol} (${address})`);
        
        const infoContent = `
            <div class="modal fade" id="tokenInfoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Token Information: ${symbol}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Symbol:</strong> ${symbol}</p>
                            <p><strong>Contract:</strong> ${address || 'Not available'}</p>
                            <p><strong>Status:</strong> Live opportunity detected</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                Detailed token analysis coming soon!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('tokenInfoModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', infoContent);
        
        const modal = new bootstrap.Modal(document.getElementById('tokenInfoModal'));
        modal.show();
    }
    
    function refreshOpportunities() {
        debugLog('info', 'üîÑ Manual refresh triggered');
        
        const button = event?.target?.closest('button');
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 1000);
        }
        
        loadLiveTokens();
    }
    
    function loadMoreOpportunities() {
        debugLog('info', 'üìà Load more opportunities triggered');
        
        fetch('/api/v1/tokens/discover?limit=20')
            .then(response => response.json())
            .then(data => {
                if (data.tokens) {
                    displayLiveOpportunities(data.tokens);
                }
            })
            .catch(error => {
                debugLog('error', 'Failed to load more opportunities:', error);
                showError('Failed to load more opportunities');
            });
    }
    
    // ==================== DEBUG HELPERS ====================
    
    // Make functions globally available for debugging
    window.dashboardDebug = {
        loadDashboardStats,
        loadLiveTokens,
        refreshOpportunities,
        debugLog,
        dashboardData: () => dashboardData,
        walletManager: () => walletManager
    };
    
    // Legacy compatibility
    function initPerformanceChart() {
        debugLog('info', 'üîÑ Legacy initPerformanceChart called - using CSS chart');
        return true;
    }
    
    // Make available globally
    window.initPerformanceChart = initPerformanceChart;
    
    debugLog('info', '‚úÖ Dashboard script loaded and ready');
</script>
{% endblock %}