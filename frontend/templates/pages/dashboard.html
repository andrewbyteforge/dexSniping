{% extends "base/layout.html" %}

{% block title %}Trading Dashboard{% endblock %}

{% block page_title %}Professional Trading Dashboard{% endblock %}
{% block page_subtitle %}Real-time DEX monitoring and AI-powered analysis{% endblock %}

{% block extra_css %}
<!-- Dashboard Opportunities Styling -->
<link href="{{ url_for('static', path='css/dashboard_opportunities.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Dashboard Status Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>System Status:</strong>
            <span class="ms-2">All systems operational</span>
            <div class="ms-auto">
                <small>Last update: <span id="lastUpdateTime">--:--:--</span></small>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Portfolio Value</h6>
                        <h3 class="mb-0" id="portfolioValue">Loading...</h3>
                        <small class="text-white-50">
                            <i class="bi bi-graph-up"></i> 
                            <span id="portfolioChange">+0.00%</span>
                        </small>
                    </div>
                    <i class="bi bi-wallet2 fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Daily P&L</h6>
                        <h3 class="mb-0" id="dailyPnL">Loading...</h3>
                        <small class="text-white-50">
                            <span id="dailyPnLPercent">0.00%</span> return
                        </small>
                    </div>
                    <i class="bi bi-graph-up-arrow fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Active Trades</h6>
                        <h3 class="mb-0" id="activeTrades">0</h3>
                        <small class="text-white-50">
                            <span id="successRate">0%</span> success
                        </small>
                    </div>
                    <i class="bi bi-activity fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-white-50">Discovered</h6>
                        <h3 class="mb-0" id="tokensDiscovered">0</h3>
                        <small class="text-white-50">
                            <span id="discovered24h">0</span> today
                        </small>
                    </div>
                    <i class="bi bi-search fs-1 text-white-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="row">
    <!-- Live Tokens Section -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-search text-primary"></i>
                    Live Opportunities
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshOpportunities()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Refresh
                    </button>
                    <span class="badge bg-success">
                        <i class="bi bi-dot"></i>
                        Live
                    </span>
                </div>
            </div>
            <div class="card-body" style="height: 400px; overflow-y: auto;">
                <div id="tokensContainer">
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Scanning for new opportunities...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Side Panel -->
    <div class="col-lg-4 mb-4">
        <!-- Performance Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up text-primary"></i> 
                    Performance
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 200px;">
                    <!-- Simple CSS-based chart alternative -->
                    <div id="performanceChart" class="simple-chart">
                        <div class="chart-title">Portfolio Performance (30 Days)</div>
                        <div class="chart-bars">
                            <div class="chart-bar" style="height: 60%;" title="Day 1: $10,200"></div>
                            <div class="chart-bar" style="height: 65%;" title="Day 5: $10,650"></div>
                            <div class="chart-bar" style="height: 58%;" title="Day 10: $10,100"></div>
                            <div class="chart-bar" style="height: 72%;" title="Day 15: $11,200"></div>
                            <div class="chart-bar" style="height: 68%;" title="Day 20: $10,800"></div>
                            <div class="chart-bar" style="height: 75%;" title="Day 25: $11,500"></div>
                            <div class="chart-bar" style="height: 80%;" title="Day 30: $12,000"></div>
                        </div>
                        <div class="chart-trend text-success">
                            <i class="bi bi-trending-up"></i> +18% this month
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Alerts -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-bell text-danger"></i> 
                    Alerts
                </h5>
            </div>
            <div class="card-body" style="height: 250px; overflow-y: auto;">
                <div id="alertsContainer">
                    <div class="alert alert-info alert-sm">
                        <i class="bi bi-info-circle"></i>
                        <strong>New Token:</strong> MOONSHOT detected on Ethereum
                        <small class="d-block text-muted">2 minutes ago</small>
                    </div>
                    <div class="alert alert-warning alert-sm">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>High Volume:</strong> PEPE volume spike +300%
                        <small class="d-block text-muted">5 minutes ago</small>
                    </div>
                    <div class="alert alert-success alert-sm">
                        <i class="bi bi-check-circle"></i>
                        <strong>Trade Complete:</strong> WOJAK buy order executed
                        <small class="d-block text-muted">8 minutes ago</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add simple chart styling -->
<style>
.simple-chart {
    padding: 1rem;
    text-align: center;
}

.chart-title {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 1rem;
}

.chart-bars {
    display: flex;
    align-items: end;
    justify-content: space-between;
    height: 120px;
    margin: 1rem 0;
    gap: 4px;
}

.chart-bar {
    background: linear-gradient(to top, #667eea, #764ba2);
    border-radius: 2px 2px 0 0;
    flex: 1;
    min-height: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.chart-bar:hover {
    transform: scaleY(1.1);
    filter: brightness(1.2);
}

.chart-trend {
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.alert-sm {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.alert-sm:last-child {
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // ==================== ENHANCED LOGGING UTILITIES ====================
    
    function debugLog(level, message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const prefix = `[${timestamp}] DEX-${level.toUpperCase()}:`;
        
        switch (level) {
            case 'error':
                console.error(prefix, message, data || '');
                break;
            case 'warn':
                console.warn(prefix, message, data || '');
                break;
            case 'info':
                console.info(prefix, message, data || '');
                break;
            default:
                console.log(prefix, message, data || '');
        }
    }
    
    // ==================== GLOBAL VARIABLES ====================
    
    let dashboardData = {};
    let performanceChart = null;
    let chartInitialized = false;
    
    // ==================== MAIN INITIALIZATION ====================
    
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('info', '🚀 DEX Sniper Pro Dashboard starting...');
        initializeDashboard();
    });
    
    async function initializeDashboard() {
        debugLog('info', '📊 Initializing dashboard components...');
        
        try {
            // Skip Chart.js initialization - use CSS chart instead
            debugLog('info', '📈 Using CSS-based chart (Chart.js skipped)');
            chartInitialized = true;
            
            // Load dashboard data
            debugLog('info', '📊 Loading dashboard data...');
            await loadDashboardStats();
            await loadLiveTokens();
            
            // Setup auto-refresh
            debugLog('info', '🔄 Setting up auto-refresh...');
            setupAutoRefresh();
            
            debugLog('info', '✅ Dashboard initialization complete');
            
        } catch (error) {
            debugLog('error', '❌ Dashboard initialization failed:', error);
            showError('Dashboard initialization failed. Some features may not work.');
        }
    }
    
    // ==================== API DATA LOADING ====================
    
    async function loadDashboardStats() {
        try {
            debugLog('info', '📊 Fetching dashboard stats...');
            
            const response = await fetch('/api/v1/dashboard/stats');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            debugLog('info', '✅ Dashboard stats received:', data);
            
            updateDashboardStats(data);
            dashboardData = data;
            
        } catch (error) {
            debugLog('error', '❌ Failed to load dashboard stats:', error);
            showError('Failed to load dashboard statistics');
        }
    }
    
    function updateDashboardStats(data) {
        try {
            debugLog('info', '🔄 Updating dashboard statistics display...');
            
            // Helper function to safely format values
            function safeFormat(value, type = 'number') {
                if (value === null || value === undefined) return '0';
                
                switch (type) {
                    case 'currency':
                        if (typeof value === 'string' && value.includes('$')) return value;
                        return formatCurrency(parseFloat(value) || 0);
                    
                    case 'percentage':
                        if (typeof value === 'string' && value.includes('%')) return value;
                        return (parseFloat(value) || 0).toFixed(1) + '%';
                    
                    case 'number':
                    default:
                        return (parseFloat(value) || 0).toString();
                }
            }
            
            // Extract data from response structure
            const statsData = data.data || data;
            
            // Update stats display with safe formatting
            updateElement('portfolioValue', safeFormat(statsData.portfolio_value, 'currency'));
            updateElement('dailyPnL', safeFormat(statsData.daily_pnl, 'currency'));
            updateElement('activeTrades', safeFormat(statsData.trades_today || statsData.active_trades, 'number'));
            updateElement('tokensDiscovered', safeFormat(statsData.total_discovered, 'number'));
            updateElement('successRate', safeFormat(statsData.success_rate, 'percentage'));
            updateElement('discovered24h', safeFormat(statsData.discovered_24h, 'number'));
            
            // Handle P&L percentage
            if (statsData.daily_pnl_percent !== undefined) {
                updateElement('dailyPnLPercent', safeFormat(statsData.daily_pnl_percent, 'percentage'));
            }
            
            // Handle portfolio change with color coding
            if (statsData.portfolio_value_change !== undefined) {
                const changeElement = document.getElementById('portfolioChange');
                if (changeElement) {
                    const changeValue = parseFloat(statsData.portfolio_value_change) || 0;
                    const isPositive = changeValue >= 0;
                    changeElement.textContent = (isPositive ? '+' : '') + safeFormat(changeValue, 'percentage');
                    changeElement.className = isPositive ? 'text-success' : 'text-danger';
                }
            }
            
            debugLog('info', '✅ Dashboard statistics updated successfully');
            
        } catch (error) {
            debugLog('error', '❌ Error updating dashboard stats:', error);
        }
    }
    
    async function loadLiveTokens() {
        try {
            debugLog('info', '🔍 Fetching live opportunities...');
            
            const response = await fetch('/api/v1/tokens/discover?limit=10');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            debugLog('info', '✅ Live opportunities received:', data);
            
            // Handle the API response structure correctly
            let tokens = null;
            if (data.tokens && Array.isArray(data.tokens)) {
                tokens = data.tokens;
                debugLog('info', `📊 Found ${tokens.length} tokens in data.tokens`);
            } else if (data.discovered_tokens && Array.isArray(data.discovered_tokens)) {
                tokens = data.discovered_tokens;
                debugLog('info', `📊 Found ${tokens.length} tokens in data.discovered_tokens`);
            } else if (Array.isArray(data)) {
                tokens = data;
                debugLog('info', `📊 Using direct array with ${tokens.length} tokens`);
            } else {
                debugLog('warn', '⚠️ No valid token array found in response');
                tokens = [];
            }
            
            if (tokens && tokens.length > 0) {
                debugLog('info', `🎯 Displaying ${tokens.length} opportunities`);
                displayLiveOpportunities(tokens);
            } else {
                debugLog('info', '📝 No opportunities found, showing empty state');
                showNoTokensMessage();
            }
            
        } catch (error) {
            debugLog('error', '❌ Failed to load live opportunities:', error);
            showTokensError();
        }
    }
    
    function displayLiveOpportunities(tokens) {
        const container = document.getElementById('tokensContainer');
        
        debugLog('info', `🎯 displayLiveOpportunities called with ${tokens ? tokens.length : 0} tokens`);
        debugLog('info', `🎯 Container found: ${container ? 'YES' : 'NO'}`);
        
        if (!container) {
            debugLog('error', '❌ tokensContainer not found in DOM!');
            return;
        }
        
        if (!tokens || tokens.length === 0) {
            debugLog('info', '⚠️ No tokens to display');
            showNoTokensMessage();
            return;
        }
        
        let html = '';
        
        tokens.forEach((token, index) => {
            debugLog('debug', `Processing token ${index}:`, token);
            
            const price = parseFloat(token.price || token.current_price || 0);
            const priceChange = parseFloat(token.price_change_24h || token.price_change || token.change_24h || 0);
            const liquidity = parseFloat(token.liquidity || token.liquidity_usd || 0);
            const isPositive = priceChange >= 0;
            const aiScore = parseFloat(token.ai_score || token.score || Math.random() * 10);
            
            // Calculate age
            let ageText = 'Unknown';
            if (token.discovered_at || token.created_at) {
                const discoveredTime = new Date(token.discovered_at || token.created_at);
                const now = new Date();
                const diffMinutes = Math.floor((now - discoveredTime) / (1000 * 60));
                
                if (diffMinutes < 60) {
                    ageText = `${diffMinutes}m`;
                } else {
                    const hours = Math.floor(diffMinutes / 60);
                    const minutes = diffMinutes % 60;
                    ageText = `${hours}h ${minutes}m`;
                }
            }
            
            html += `
                <div class="opportunity-card p-3 mb-3" style="border: 1px solid #dee2e6; border-radius: 8px; background: white;">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="token-symbol fw-bold">${escapeHtml(token.symbol || 'UNKNOWN')}</div>
                            <small class="text-muted">${escapeHtml(token.name || 'Unknown Token')}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">$${price > 0 ? price.toFixed(8) : '0.00000000'}</div>
                            <div class="price-change-${isPositive ? 'positive' : 'negative'}" style="color: ${isPositive ? '#28a745' : '#dc3545'};">
                                ${isPositive ? '+' : ''}${priceChange.toFixed(1)}%
                            </div>
                        </div>
                        <div class="col-md-2">
                            <span class="liquidity-badge badge bg-info">$${formatLiquidity(liquidity)}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Age:</small>
                            <div class="fw-bold">${ageText}</div>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-trade btn-sm me-2" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;" onclick="snipeToken('${token.symbol}', '${token.address || ''}')">
                                <i class="bi bi-lightning"></i>
                                Snipe
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="showTokenInfo('${token.symbol}', '${token.address || ''}')">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">
                                Network: <span class="badge bg-secondary">${escapeHtml(token.network || 'Unknown')}</span>
                                ${aiScore > 0 ? ` | AI Score: <span class="badge ${aiScore > 7 ? 'bg-success' : aiScore > 4 ? 'bg-warning' : 'bg-danger'}">${aiScore.toFixed(1)}</span>` : ''}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Add "Load More" button
        html += `
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="loadMoreOpportunities()">
                    <i class="bi bi-plus-circle"></i>
                    Load More Opportunities
                </button>
            </div>
        `;
        
        debugLog('info', `🎯 Setting container HTML (${html.length} characters)`);
        
        try {
            container.innerHTML = html;
            debugLog('info', '✅ Live opportunities display updated successfully');
        } catch (error) {
            debugLog('error', '❌ Error setting container HTML:', error);
        }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    function formatLiquidity(value) {
        if (value >= 1000000) {
            return (value / 1000000).toFixed(1) + 'M';
        } else if (value >= 1000) {
            return (value / 1000).toFixed(1) + 'K';
        }
        return value.toFixed(0);
    }
    
    function updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
            debugLog('debug', `Updated ${id}: ${value}`);
        } else {
            debugLog('warn', `Element not found: ${id}`);
        }
    }
    
    function formatCurrency(value) {
        try {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value || 0);
        } catch (error) {
            return '$' + (value || 0).toFixed(2);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ==================== ERROR HANDLING ====================
    
    function showError(message) {
        debugLog('error', 'Dashboard Error:', message);
        // Could add toast notification here
    }
    
    function showNoTokensMessage() {
        const container = document.getElementById('tokensContainer');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-info-circle fs-1"></i>
                    <p class="mt-3">No opportunities found at this time</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadLiveTokens()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            `;
        }
    }
    
    function showTokensError() {
        const container = document.getElementById('tokensContainer');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                    <p class="mt-3">Failed to load opportunities</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadLiveTokens()">
                        <i class="bi bi-arrow-clockwise"></i> Retry
                    </button>
                </div>
            `;
        }
    }
    
    // ==================== AUTO-REFRESH SYSTEM ====================
    
    function setupAutoRefresh() {
        // Update stats every 30 seconds
        setInterval(() => {
            debugLog('info', '🔄 Auto-refreshing dashboard stats...');
            loadDashboardStats();
        }, 30000);
        
        // Update tokens every 10 seconds
        setInterval(() => {
            debugLog('info', '🔄 Auto-refreshing opportunities...');
            loadLiveTokens();
        }, 10000);
        
        // Update timestamp every second
        setInterval(updateTimestamp, 1000);
        
        debugLog('info', '✅ Auto-refresh system activated');
    }
    
    function updateTimestamp() {
        const element = document.getElementById('lastUpdateTime');
        if (element) {
            element.textContent = new Date().toLocaleTimeString();
        }
    }
    
    // ==================== OPPORTUNITY ACTIONS ====================
    
    function snipeToken(symbol, address) {
        debugLog('info', `⚡ Snipe action triggered for ${symbol} (${address})`);
        
        if (confirm(`Execute snipe trade for ${symbol}?\n\nThis will attempt to buy this token using your configured trading parameters.`)) {
            alert(`Snipe order submitted for ${symbol}!\n\nNote: This is a demonstration. In production, this would connect to your trading engine.`);
        }
    }
    
    function showTokenInfo(symbol, address) {
        debugLog('info', `ℹ️ Show info requested for ${symbol} (${address})`);
        
        const infoContent = `
            <div class="modal fade" id="tokenInfoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Token Information: ${symbol}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Symbol:</strong> ${symbol}</p>
                            <p><strong>Contract:</strong> ${address || 'Not available'}</p>
                            <p><strong>Status:</strong> Live opportunity detected</p>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                Detailed token analysis coming soon!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('tokenInfoModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', infoContent);
        
        const modal = new bootstrap.Modal(document.getElementById('tokenInfoModal'));
        modal.show();
    }
    
    function refreshOpportunities() {
        debugLog('info', '🔄 Manual refresh triggered');
        
        const button = event?.target?.closest('button');
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
            }, 1000);
        }
        
        loadLiveTokens();
    }
    
    function loadMoreOpportunities() {
        debugLog('info', '📈 Load more opportunities triggered');
        
        fetch('/api/v1/tokens/discover?limit=20')
            .then(response => response.json())
            .then(data => {
                if (data.tokens) {
                    displayLiveOpportunities(data.tokens);
                }
            })
            .catch(error => {
                debugLog('error', 'Failed to load more opportunities:', error);
                showError('Failed to load more opportunities');
            });
    }
    
    // ==================== DEBUG HELPERS ====================
    
    // Make functions globally available for debugging
    window.dashboardDebug = {
        loadDashboardStats,
        loadLiveTokens,
        refreshOpportunities,
        debugLog,
        dashboardData: () => dashboardData
    };
    
    // Legacy compatibility
    function initPerformanceChart() {
        debugLog('info', '🔄 Legacy initPerformanceChart called - using CSS chart');
        return true;
    }
    
    // Make available globally
    window.initPerformanceChart = initPerformanceChart;
    
    debugLog('info', '✅ Dashboard script loaded and ready');
</script>
{% endblock %}