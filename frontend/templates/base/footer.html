<!-- Bootstrap JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js" 
        crossorigin="anonymous"></script>

<!-- Core Application Scripts - Load Once -->
<script>
// Prevent duplicate script loading
if (!window.DEX_SNIPER_SCRIPTS_LOADED) {
    window.DEX_SNIPER_SCRIPTS_LOADED = {};
}

function loadScript(src, id) {
    if (window.DEX_SNIPER_SCRIPTS_LOADED[id]) {
        console.log(`Script already loaded: ${id}`);
        return Promise.resolve();
    }
    
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
            window.DEX_SNIPER_SCRIPTS_LOADED[id] = true;
            console.log(`‚úÖ Script loaded: ${id}`);
            resolve();
        };
        script.onerror = () => {
            console.error(`‚ùå Failed to load script: ${id}`);
            reject(new Error(`Failed to load ${id}`));
        };
        document.head.appendChild(script);
    });
}

// Load scripts in order
async function loadApplicationScripts() {
    try {
        // Load utility modules first
        await loadScript('/static/js/utils/constants.js', 'constants');
        await loadScript('/static/js/utils/formatters.js', 'formatters');
        await loadScript('/static/js/utils/validators.js', 'validators');
        
        // Load core modules
        await loadScript('/static/js/api-client.js', 'api-client');
        await loadScript('/static/js/websocket-manager.js', 'websocket-manager');
        
        // Load component controllers
        await loadScript('/static/js/components/dashboard-controller.js', 'dashboard-controller');
        await loadScript('/static/js/components/token-discovery-controller.js', 'token-discovery-controller');
        await loadScript('/static/js/components/chart-controller.js', 'chart-controller');
        
        // Load main application controller last
        await loadScript('/static/js/app.js', 'app');
        
        console.log('‚úÖ All application scripts loaded');
        
        // Initialize application
        if (typeof DexSniperApp !== 'undefined' && DexSniperApp.init) {
            await DexSniperApp.init();
        } else {
            console.warn('‚ö†Ô∏è DexSniperApp not available for initialization');
        }
        
    } catch (error) {
        console.error('‚ùå Failed to load application scripts:', error);
    }
}

// Only load scripts if not already loaded
if (!window.DEX_SNIPER_SCRIPTS_LOADED.app) {
    loadApplicationScripts();
}
</script>

<!-- Application Initialization -->
<script>
    // Global application configuration
    window.DEX_SNIPER_CONFIG = {
        API_BASE_URL: '/api/v1',
        WEBSOCKET_URL: `ws://${window.location.host}/api/v1/dashboard/ws`,
        VERSION: '3.1.0',
        PHASE: '3B',
        DEBUG: {{ 'true' if debug else 'false' }},
        FEATURES: {
            TOKEN_DISCOVERY: true,
            LIVE_TRADING: false,  // Phase 3B Week 5-6
            ARBITRAGE: false,     // Phase 3B Week 5-6
            AI_RISK: false,       // Phase 3B Week 7-8
            MOBILE_APP: false     // Phase 3C
        },
        NETWORKS: [
            'Ethereum',
            'Polygon', 
            'BSC',
            'Arbitrum',
            'Optimism',
            'Avalanche',
            'Fantom',
            'Solana'
        ],
        REFRESH_INTERVALS: {
            STATS: 10000,         // 10 seconds
            TOKENS: 30000,        // 30 seconds
            PORTFOLIO: 60000,     // 1 minute
            ALERTS: 5000          // 5 seconds
        }
    };

    // Performance monitoring
    window.PERFORMANCE_MONITOR = {
        startTime: performance.now(),
        apiCalls: 0,
        webSocketReconnects: 0,
        errors: []
    };

    // Error tracking
    window.addEventListener('error', function(event) {
        window.PERFORMANCE_MONITOR.errors.push({
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            timestamp: new Date().toISOString()
        });
        
        // Log to console in debug mode
        if (window.DEX_SNIPER_CONFIG.DEBUG) {
            console.error('Application Error:', {
                message: event.message,
                source: event.filename,
                line: event.lineno,
                stack: event.error?.stack
            });
        }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM Content Loaded');
        
        // Wait a bit for all scripts to load
        setTimeout(() => {
            if (typeof DexSniperApp !== 'undefined' && DexSniperApp.init) {
                console.log('üöÄ Initializing DexSniperApp...');
                DexSniperApp.init().catch(error => {
                    console.error('‚ùå DexSniperApp initialization failed:', error);
                });
            } else {
                console.warn('‚ö†Ô∏è DexSniperApp not available');
            }
        }, 1000);
    });
</script>